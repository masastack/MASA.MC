@inherits AdminCompontentBase
<div @ref="Ref">
    <McModal Value="@_visible" ValueChanged="HandleVisibleChanged" Title="@T("Permission.SendOrdinaryMessage")" Height="850">
        <ChildContent>
            <MForm Model="_model" EnableValidation @ref="_form" Class="full-height">
                <ElevationTab @bind-TabIndex="_tabIndex" TabMinWidth="227" Tabs='new List<string> { T("DisplayName.MessageTaskReceiver"), T("DisplayName.MessageInfoContent"), T("DisplayName.MessageTaskSendingRule") }' Dense>
                    <ElevationTabItem>
                        @if (_model.ReceiverType == ReceiverTypes.Assign)
                        {
                            <MInput @bind-Value="_model.Receivers" />
                            <MessageReceivers @bind-ReceiverType="_model.ReceiverType"
                                          @bind-SelectReceivers="_selectReceivers"
                                          @bind-ImportReceivers="_importReceivers"
                                          @bind-SelectReceiverType="_model.SelectReceiverType"
                                          ChannelType="_channelType" />
                        }
                        else
                        {
                            <MContainer Fluid Class="pt-9 px-1 full-height">
                                <MRow Align="AlignTypes.Center" Justify="JustifyTypes.SpaceBetween">
                                    <MCol>
                                        <MHover Context="hoverContext">
                                            <MCard @attributes="hoverContext.Attrs" Height="320" Width="320" Class="@($"d-flex flex-column justify-center align-center {hoverContext.Class} {(hoverContext.Hover ? "primary" : "fill-background")}")"
                                               Elevation="@(hoverContext.Hover ? 12 : 2)"
                                               OnClick="()=>HandleReceiverType(ReceiverTypes.Assign)">
                                                @if (hoverContext.Hover)
                                                {
                                                    <MIcon Size=40 Color="#FFFFFF">mdi-account-supervisor-circle-outline</MIcon>
                                                    <div class="h6 pt-10" style="color:#FAFAFA">@T("DisplayName.ReceiverType.Assign")</div>
                                                }
                                                else
                                                {
                                                    <MIcon Size=40 Color="#323D6F">mdi-account-supervisor-circle</MIcon>
                                                    <div class="h6 pt-10 regular--text">@T("DisplayName.ReceiverType.Assign")</div>
                                                }
                                            </MCard>
                                        </MHover>
                                    </MCol>
                                    <MCol>
                                        <MHover Context="hoverContext">
                                            <MCard @attributes="hoverContext.Attrs" Height="320" Width="320" Class="@($"d-flex flex-column justify-center align-center {hoverContext.Class} {(hoverContext.Hover ? "primary" : "fill-background")}")"
                                               Elevation="@(hoverContext.Hover ? 12 : 2)"
                                               OnClick="()=>HandleReceiverType(ReceiverTypes.Broadcast)">
                                                @if (hoverContext.Hover)
                                                {
                                                    <MIcon Size=40 Color="#FFFFFF">mdi-email-outline</MIcon>
                                                    <div class="h6 pt-10" style="color:#FAFAFA">@T("DisplayName.ReceiverType.Broadcast")</div>
                                                }
                                                else
                                                {
                                                    <MIcon Size=40 Color="#323D6F">mdi-email</MIcon>
                                                    <div class="h6 pt-10 regular--text">@T("DisplayName.ReceiverType.Broadcast")</div>
                                                }
                                            </MCard>
                                        </MHover>
                                    </MCol>
                                </MRow>
                            </MContainer>
                        }
                    </ElevationTabItem>
                    <ElevationTabItem>
                        <MRow Class="mt-6">
                            <MCol>
                                <DefaultSelect @bind-Value="@_channelType"
                                               Items="@(GetEnumList<ChannelTypes>().Where(x=>x!=ChannelTypes.Sms).ToList())"
                                               Label="@T("DisplayName.ChannelType")"
                                               ItemText="item => T(item.ToString())"
                                               ItemValue="item => item"
                                               TItem="ChannelTypes"
                                               TItemValue="ChannelTypes"
                                               TValue="ChannelTypes"
                                               OnSelectedItemUpdate="HandleChannelTypeChangeAsync">
                                </DefaultSelect>
                            </MCol>
                        </MRow>
                        <MRow Class="mt-6">
                            <MCol>
                                <DefaultSelect @bind-Value="_model.ChannelId"
                                               Items="@_channelItems"
                                               Label="@T("DisplayName.Channel")"
                                               ItemText="item => item.DisplayName"
                                               ItemValue="item => item.Id">
                                </DefaultSelect>
                            </MCol>
                        </MRow>
                        @if (_channelType != ChannelTypes.Sms)
                        {
                            <MRow Class="mt-6">
                                <MCol>
                                    <DefaultTextField @bind-Value="_model.MessageInfo.Title"
                                                  Label="@T("DisplayName.MessageInfoTitle")">
                                    </DefaultTextField>
                                </MCol>
                            </MRow>
                        }
                        <MRow Class="mt-6">
                            <MCol>
                                <DefaultMarkdown @bind-Html="_model.MessageInfo.Content" @bind-Value="_model.MessageInfo.Markdown"></DefaultMarkdown>
                                <MInput @bind-Value="_model.MessageInfo.Content" />
                            </MCol>
                        </MRow>
                        @if (_channelType == ChannelTypes.WebsiteMessage)
                        {
                            <MRow Class="mt-6">
                                <MCol>
                                    <DefaultTextField @bind-Value="_model.MessageInfo.JumpUrl"
                                                  Label="@T("DisplayName.MessageTemplateJumpUrl")">
                                        <PrependContent>
                                            <MCheckbox Class="mt-0" @bind-Value="_model.MessageInfo.IsJump"></MCheckbox>
                                        </PrependContent>
                                    </DefaultTextField>
                                </MCol>
                            </MRow>
                        }
                        @if (_channelType == ChannelTypes.Sms)
                        {
                            <MRow Class="mt-6">
                                <MCol>
                                    <DefaultTextField @bind-Value="_model.Sign"
                                                  Label="@T("DisplayName.MessageTemplateSign")">
                                    </DefaultTextField>
                                </MCol>
                            </MRow>
                        }
                    </ElevationTabItem>
                    <ElevationTabItem>
                        <MInput @bind-Value="_model.SendRules" />
                        <MessageSendingRules Class="mt-2" @bind-Value="_model.SendRules" />
                    </ElevationTabItem>
                </ElevationTab>
            </MForm>
        </ChildContent>
        <ActionContent>
            @if (_tabIndex == 1)
            {
                <MIcon Size="24" Color="emphasis2" OnClick="()=> _tabIndex=0">mdi-keyboard-backspace</MIcon>
                <MSpacer></MSpacer>
                <MButton Color="fill" Class="btn-form btn-fill-line rounded-3 emphasis2--text" OnClick="async() => await HandleOkAsync(true)">@T("Save")</MButton>
                <MButton Color="primary" Class="btn-form ml-6" OnClick="()=> _tabIndex=2">@T("NextStep")</MButton>
            }
            @if (_tabIndex == 2)
            {
                <MIcon Size="24" Color="emphasis2" OnClick="()=> _tabIndex=1">mdi-keyboard-backspace</MIcon>
                <MSpacer></MSpacer>
                <MButton Color="fill" Class="btn-form btn-fill-line rounded-3 emphasis2--text" OnClick="async() => await HandleOkAsync(true)">@T("Save")</MButton>
                <MButton Color="primary" Class="btn-form ml-6" OnClick="async() => await HandleOkAsync(false)">@T("SaveSend")</MButton>
            }
        </ActionContent>
    </McModal>
</div>